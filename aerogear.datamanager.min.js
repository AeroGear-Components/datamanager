/*! AeroGear JavaScript Library - v1.3.2 - 2014-01-29
* https://github.com/aerogear/aerogear-js
* JBoss, Home of Professional Open Source
* Copyright Red Hat, Inc., and individual contributors
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
* http://www.apache.org/licenses/LICENSE-2.0
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
(function(e,t){this.AeroGear={},AeroGear.Core=function(){if(this instanceof AeroGear.Core)throw"Invalid instantiation of base class AeroGear.Core";this.add=function(e){var t,a,r=this[this.collectionName]||{};if(this[this.collectionName]=r,!e)return this;if("string"==typeof e)r[e]=AeroGear[this.lib].adapters[this.type](e,this.config);else if(AeroGear.isArray(e))for(t=0;e.length>t;t++)a=e[t],"string"==typeof a?r[a]=AeroGear[this.lib].adapters[this.type](a,this.config):a.name&&(a.settings=AeroGear.extend(a.settings||{},this.config),a.settings.recordId=a.settings.recordId||a.recordId,r[a.name]=AeroGear[this.lib].adapters[a.type||this.type](a.name,a.settings));else{if(!e.name)return this;e.settings=AeroGear.extend(e.settings||{},this.config),e.settings.recordId=e.settings.recordId||e.recordId,r[e.name]=AeroGear[this.lib].adapters[e.type||this.type](e.name,e.settings)}return this[this.collectionName]=r,this},this.remove=function(e){var t,a,r=this[this.collectionName]||{};if("string"==typeof e)delete r[e];else if(AeroGear.isArray(e))for(t=0;e.length>t;t++)a=e[t],"string"==typeof a?delete r[a]:delete r[a.name];else e&&delete r[e.name];return this[this.collectionName]=r,this}},AeroGear.isArray=function(e){return"[object Array]"==={}.toString.call(e)},AeroGear.extend=function(e,t){var a;for(a in t)e[a]=t[a];return e},AeroGear.DataManager=function(e){return this instanceof AeroGear.DataManager?(this.add=function(e){e=e||{};var t,a,r,s,o;e=AeroGear.isArray(e)?e:[e],e=e.map(function(e){if(o=e.settings||{},r=o.fallback===!1?!1:!0,r&&(s=o.preferred?o.preferred:AeroGear.DataManager.preferred,"string"!=typeof e&&(a=e.type||"Memory",!(a in AeroGear.DataManager.validAdapters))))for(t=0;s.length>t;t++)if(s[t]in AeroGear.DataManager.validAdapters)return("IndexedDB"===a||"WebSQL"===a)&&(e.settings=AeroGear.extend(e.settings||{},{async:!0})),e.type=s[t],e;return e},this),AeroGear.Core.call(this),this.add(e),this.add=this._add},this._add=this.add,this.remove=function(e){AeroGear.Core.call(this),this.remove(e),this.remove=this._remove},this._remove=this.remove,this.lib="DataManager",this.type=e?e.type||"Memory":"Memory",this.collectionName="stores",this.add(e),t):new AeroGear.DataManager(e)},AeroGear.DataManager.prototype=AeroGear.Core,AeroGear.DataManager.constructor=AeroGear.DataManager,AeroGear.DataManager.validAdapters={},AeroGear.DataManager.preferred=["IndexedDB","WebSQL","SessionLocal","Memory"],AeroGear.DataManager.validateAdapter=function(e,t){t.isValid()&&(AeroGear.DataManager.validAdapters[e]=t)},AeroGear.DataManager.adapters={},AeroGear.DataManager.STATUS_NEW=1,AeroGear.DataManager.STATUS_MODIFIED=2,AeroGear.DataManager.STATUS_REMOVED=0,AeroGear.DataManager.adapters.base=function(t,a){if(this instanceof AeroGear.DataManager.adapters.base)throw"Invalid instantiation of base class AeroGear.DataManager.adapters.base";a=a||{};var r=null,s=a.recordId?a.recordId:"id",o=a.crypto||{},n=o.options||{};this.getData=function(){return r||[]},this.setData=function(e){r=e},this.getRecordId=function(){return s},this.always=function(e,t,a){a&&a.call(this,e,t)},this.encrypt=function(a){var r;return o.agcrypto?(n.data=sjcl.codec.utf8String.toBits(JSON.stringify(a)),r={id:a[s],data:o.agcrypto.encrypt(n)},e.localStorage.setItem("ag-"+t+"-IV",JSON.stringify({id:o.agcrypto.getIV()})),r):a},this.decrypt=function(a,r){var s,i;return o.agcrypto?(i=JSON.parse(e.localStorage.getItem("ag-"+t+"-IV"))||{},n.IV=i.id,a=AeroGear.isArray(a)?a:[a],s=a.map(function(e){return n.data=e.data,JSON.parse(sjcl.codec.utf8String.fromBits(o.agcrypto.decrypt(n)))}),r?s[0]:s):a}},AeroGear.DataManager.adapters.Memory=function(e,a){return this instanceof AeroGear.DataManager.adapters.Memory?(AeroGear.DataManager.adapters.base.apply(this,arguments),this.emptyData=function(){this.setData(null)},this.addDataRecord=function(e){this.getData().push(e)},this.updateDataRecord=function(e,t){this.getData()[e]=t},this.removeDataRecord=function(e){this.getData().splice(e,1)},this.always=function(e,t,a){a&&a.call(this,e,t)},this.getAsync=function(){return a&&a.async?!0:!1},this.open=function(e){return jQuery.Deferred().resolve(t,"success",e&&e.success)},this.close=function(){},this.traverseObjects=function(e,t,a){for(;"object"==typeof t&&a;)e=Object.keys(t)[0],t=t[e],a=a[e];return t===a?!0:!1},t):new AeroGear.DataManager.adapters.Memory(e,a)},AeroGear.DataManager.adapters.Memory.isValid=function(){return!0},AeroGear.DataManager.adapters.Memory.prototype.read=function(e,a){var r,s={},o=jQuery.Deferred(),n=this.getAsync();return s[this.getRecordId()]=e,e?n?this.filter(s).then(function(e){r=e}):r=this.filter(s):r=this.getData(),n?(o.always(this.always),o.resolve(r,"success",a?a.success:t)):r},AeroGear.DataManager.adapters.Memory.prototype.save=function(e,a){var r=!1,s=jQuery.Deferred(),o=this.getAsync();if(e=AeroGear.isArray(e)?e:[e],a&&a.reset)this.setData(e);else if(this.getData()&&0!==this.getData().length)for(var n=0;e.length>n;n++){for(var i in this.getData())if(this.getData()[i][this.getRecordId()]===e[n][this.getRecordId()]){this.updateDataRecord(i,e[n]),r=!0;break}r||this.addDataRecord(e[n]),r=!1}else this.setData(e);return o?(s.always(this.always),s.resolve(this.getData(),"success",a?a.success:t)):this.getData()},AeroGear.DataManager.adapters.Memory.prototype.remove=function(e,a){var r,s,o,n=jQuery.Deferred(),i=this.getAsync();if(n.always(this.always),!e)return this.emptyData(),i?n.resolve(this.getData(),"success",a?a.success:t):this.getData();e=AeroGear.isArray(e)?e:[e];for(var c=0;e.length>c;c++){if("string"==typeof e[c]||"number"==typeof e[c])r=e[c];else{if(!e)continue;r=e[c][this.getRecordId()]}s=this.getData(!0);for(o in s)s[o][this.getRecordId()]===r&&this.removeDataRecord(o)}return i?n.resolve(this.getData(),"success",a?a.success:t):this.getData()},AeroGear.DataManager.adapters.Memory.prototype.filter=function(e,a,r){var s,o,n,i,c,u=this,d=jQuery.Deferred(),h=this.getAsync();return d.always(this.always),e?(s=this.getData().filter(function(t){var r,s,d=a?!1:!0,h=Object.keys(e);for(o=0;h.length>o;o++){if(e[h[o]].data)for(r=e[h[o]],s=r.matchAny?!1:!0,n=0;r.data.length>n;n++)if(AeroGear.isArray(t[h[o]]))if(t[h[o]].length){if(0===jQuery(t[h]).not(r.data).length&&0===jQuery(r.data).not(t[h]).length){s=!0;break}for(i=0;t[h[o]].length>i;i++){if(r.matchAny&&r.data[n]===t[h[o]][i]){if(s=!0,a)break;for(c=0;t[h[o]].length>c;c++)if(!a&&r.data[n]!==t[h[o]][c]){s=!1;break}}if(!r.matchAny&&r.data[n]!==t[h[o]][i]){s=!1;break}}}else s=!1;else if("object"==typeof r.data[n]){if(r.matchAny&&u.traverseObjects(h[o],r.data[n],t[h[o]])){s=!0;break}if(!r.matchAny&&!u.traverseObjects(h[o],r.data[n],t[h[o]])){s=!1;break}}else{if(r.matchAny&&r.data[n]===t[h[o]]){s=!0;break}if(!r.matchAny&&r.data[n]!==t[h[o]]){s=!1;break}}else if(AeroGear.isArray(t[h[o]]))if(s=a?!1:!0,t[h[o]].length)for(n=0;t[h[o]].length>n;n++){if(a&&e[h[o]]===t[h[o]][n]){s=!0;break}if(!a&&e[h[o]]!==t[h[o]][n]){s=!1;break}}else s=!1;else s="object"==typeof e[h[o]]?u.traverseObjects(h[o],e[h[o]],t[h[o]]):e[h[o]]===t[h[o]]?!0:!1;if(a&&s){d=!0;break}if(!a&&!s){d=!1;break}}return d}),h?d.resolve(s,"success",r?r.success:t):s):(s=this.getData()||[],h?d.resolve(s,"success",r?r.success:t):s)},AeroGear.DataManager.validateAdapter("Memory",AeroGear.DataManager.adapters.Memory),AeroGear.DataManager.adapters.SessionLocal=function(t,a){if(!(this instanceof AeroGear.DataManager.adapters.SessionLocal))return new AeroGear.DataManager.adapters.SessionLocal(t,a);AeroGear.DataManager.adapters.Memory.apply(this,arguments);var r=a.storageType||"sessionStorage",s=t,o=document.location.pathname.replace(/[\/\.]/g,"-"),n=s+o,i=e[r].getItem(n),c=i?this.decrypt(JSON.parse(i),!0):null;c&&AeroGear.DataManager.adapters.Memory.prototype.save.call(this,c,!0),this.getStoreType=function(){return r},this.getStoreKey=function(){return n}},AeroGear.DataManager.adapters.SessionLocal.isValid=function(){return!(!e.localStorage||!e.sessionStorage)},AeroGear.DataManager.adapters.SessionLocal.prototype=Object.create(new AeroGear.DataManager.adapters.Memory,{save:{value:function(a,r){var s,o=jQuery.Deferred(),n=r&&r.reset?r.reset:!1,i=e[this.getStoreType()].getItem(this.getStoreKey()),c=this.getAsync();c?AeroGear.DataManager.adapters.Memory.prototype.save.apply(this,[arguments[0],{reset:n,async:c}]).then(function(e){s=e}):s=AeroGear.DataManager.adapters.Memory.prototype.save.apply(this,[arguments[0],{reset:n}]),o.always(this.always);try{e[this.getStoreType()].setItem(this.getStoreKey(),JSON.stringify(this.encrypt(s))),r&&r.success&&r.storageSuccess(s)}catch(u){if(i=i?JSON.parse(i):[],c?AeroGear.DataManager.adapters.Memory.prototype.save.apply(this,[i,{reset:n,async:c}]).then(function(e){s=e}):s=AeroGear.DataManager.adapters.Memory.prototype.save.apply(this,[i,{reset:n}]),r&&r.error)return c?o.reject(a,"error",r?r.error:t):r.error(u,a);throw c&&o.reject(),u}return c?o.resolve(s,"success",r?r.success:t):s},enumerable:!0,configurable:!0,writable:!0},remove:{value:function(a,r){var s,o=jQuery.Deferred(),n=this.getAsync();return n?AeroGear.DataManager.adapters.Memory.prototype.remove.apply(this,[arguments[0],{async:!0}]).then(function(e){s=e}):s=AeroGear.DataManager.adapters.Memory.prototype.remove.apply(this,arguments),e[this.getStoreType()].setItem(this.getStoreKey(),JSON.stringify(this.encrypt(s))),n?(o.always(this.always),o.resolve(s,status,r?r.success:t)):s},enumerable:!0,configurable:!0,writable:!0}}),AeroGear.DataManager.validateAdapter("SessionLocal",AeroGear.DataManager.adapters.SessionLocal),AeroGear.DataManager.adapters.IndexedDB=function(t,a){if(!e.indexedDB)throw"Your browser doesn't support IndexedDB";if(!(this instanceof AeroGear.DataManager.adapters.IndexedDB))return new AeroGear.DataManager.adapters.IndexedDB(t,a);AeroGear.DataManager.adapters.base.apply(this,arguments),a=a||{};var r,s=a.auto;this.getDatabase=function(){return r},this.setDatabase=function(e){r=e},this.getStoreName=function(){return t},this.getAsync=function(){return!0},this.run=function(e){var t=this;if(r)e.call(this,r);else{if(!s)throw"Database not opened";this.open().always(function(a,s){if("error"===s)throw"Database not opened";e.call(t,r)})}}},AeroGear.DataManager.adapters.IndexedDB.isValid=function(){return!!e.indexedDB},AeroGear.DataManager.adapters.IndexedDB.prototype.open=function(t){t=t||{};var a,r,s=this,o=this.getStoreName(),n=this.getRecordId(),i=jQuery.Deferred();return a=e.indexedDB.open(o),a.onsuccess=function(e){r=e.target.result,s.setDatabase(r),i.resolve(r,"success",t.success)},a.onerror=function(e){i.reject(e,"error",t.error)},a.onupgradeneeded=function(e){r=e.target.result,r.createObjectStore(o,{keyPath:n})},i.always(this.always),i.promise()},AeroGear.DataManager.adapters.IndexedDB.prototype.read=function(e,t){t=t||{};var a,r,s,o,n,i=this,c=[],u=(this.getDatabase(),this.getStoreName()),d=jQuery.Deferred();return n=function(n){n.objectStoreNames.contains(u)||d.resolve([],"success",t.success),a=n.transaction(u),r=a.objectStore(u),e?(o=r.get(e),o.onsuccess=function(){c.push(o.result)}):(s=r.openCursor(),s.onsuccess=function(e){var t=e.target.result;t&&(c.push(t.value),t.continue())}),a.oncomplete=function(){d.resolve(i.decrypt(c),"success",t.success)},a.onerror=function(e){d.reject(e,"error",t.error)}},this.run.call(this,n),d.always(this.always),d.promise()},AeroGear.DataManager.adapters.IndexedDB.prototype.save=function(e,t){t=t||{};var a,r,s,o=this,n=(this.getDatabase(),this.getStoreName()),i=jQuery.Deferred(),c=0;return s=function(s){if(a=s.transaction(n,"readwrite"),r=a.objectStore(n),t.reset&&r.clear(),AeroGear.isArray(e))for(c;e.length>c;c++)r.put(this.encrypt(e[c]));else r.put(this.encrypt(e));a.oncomplete=function(){o.read().done(function(e,a){"success"===a?i.resolve(e,a,t.success):i.reject(e,a,t.error)})},a.onerror=function(e){i.reject(e,"error",t.error)}},this.run.call(this,s),i.always(this.always),i.promise()},AeroGear.DataManager.adapters.IndexedDB.prototype.remove=function(e,t){t=t||{};var a,r,s,o=this,n=this.getDatabase(),i=this.getStoreName(),c=jQuery.Deferred(),u=0;return s=function(){if(r=n.transaction(i,"readwrite"),a=r.objectStore(i),e)for(e=AeroGear.isArray(e)?e:[e],u;e.length>u;u++)if("string"==typeof e[u]||"number"==typeof e[u])a.delete(e[u]);else{if(!e)continue;a.delete(e[u][this.getRecordId()])}else a.clear();r.oncomplete=function(){o.read().done(function(e,a){"success"===a?c.resolve(e,a,t.success):c.reject(e,a,t.error)})},r.onerror=function(e){c.reject(e,"error",t.error)}},this.run.call(this,s),c.always(this.always),c.promise()},AeroGear.DataManager.adapters.IndexedDB.prototype.filter=function(e,a,r){r=r||{};var s,o=this,n=jQuery.Deferred();return this.getDatabase(),s=function(){this.read().then(function(s,i){return"success"!==i?(n.reject(s,i,r.error),t):(AeroGear.DataManager.adapters.Memory.prototype.save.call(o,s,!0),AeroGear.DataManager.adapters.Memory.prototype.filter.call(o,e,a).then(function(e){n.resolve(e,"success",r.success)}),t)})},this.run.call(this,s),n.always(this.always),n.promise()},AeroGear.DataManager.adapters.IndexedDB.prototype.close=function(){var e=this.getDatabase();e&&e.close()},AeroGear.DataManager.validateAdapter("IndexedDB",AeroGear.DataManager.adapters.IndexedDB),AeroGear.DataManager.adapters.WebSQL=function(t,a){if(!e.openDatabase)throw"Your browser doesn't support WebSQL";if(!(this instanceof AeroGear.DataManager.adapters.WebSQL))return new AeroGear.DataManager.adapters.WebSQL(t,a);AeroGear.DataManager.adapters.base.apply(this,arguments),a=a||{};var r,s=a.auto;this.getDatabase=function(){return r},this.setDatabase=function(e){r=e},this.getStoreName=function(){return t},this.getAsync=function(){return!0},this.run=function(e){var t=this;if(r)e.call(this,r);else{if(!s)throw"Database not opened";this.open().always(function(a,s){if("error"===s)throw"Database not opened";e.call(t,r)})}}},AeroGear.DataManager.adapters.WebSQL.isValid=function(){return!!e.openDatabase},AeroGear.DataManager.adapters.WebSQL.prototype.open=function(t){t=t||{};var a,r,s,o=this,n="1",i=2097152,c=this.getRecordId(),u=this.getStoreName(),d=jQuery.Deferred();return s=e.openDatabase(u,n,"AeroGear WebSQL Store",i),r=function(e,a){d.reject(a,"error",t.error)},a=function(){o.setDatabase(s),d.resolve(s,"success",t.success)},s.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS "+u+" ( "+c+" REAL UNIQUE, json)",[],a,r)}),d.always(this.always),d.promise()},AeroGear.DataManager.adapters.WebSQL.prototype.read=function(e,t){t=t||{};var a,r,s,o,n=this,i=[],c=this.getStoreName(),u=(this.getDatabase(),jQuery.Deferred()),d=0;return o=function(o){r=function(e,a){u.reject(a,"error",t.error)},a=function(e,a){var r=a.rows.length;for(d;r>d;d++)i.push(JSON.parse(a.rows.item(d).json));u.resolve(n.decrypt(i),"success",t.success)},s="SELECT * FROM "+c,e&&(s+=" WHERE ID = '"+e+"'"),o.transaction(function(e){e.executeSql(s,[],a,r)})},this.run.call(this,o),u.always(this.always),u.promise()},AeroGear.DataManager.adapters.WebSQL.prototype.save=function(e,t){t=t||{};var a,r,s,o=this,n=this.getRecordId(),i=(this.getDatabase(),this.getStoreName()),c=jQuery.Deferred();return s=function(s){a=function(e,a){c.reject(a,"error",t.error)},r=function(){o.read().done(function(e,a){"success"===a?c.resolve(e,a,t.success):c.reject(e,a,t.error)})},e=AeroGear.isArray(e)?e:[e],s.transaction(function(a){t.reset&&(a.executeSql("DROP TABLE "+i),a.executeSql("CREATE TABLE IF NOT EXISTS "+i+" ( "+n+" REAL UNIQUE, json)")),e.forEach(function(e){e=o.encrypt(e),a.executeSql("INSERT OR REPLACE INTO "+i+" ( id, json ) VALUES ( ?, ? ) ",[e[n],JSON.stringify(e)])})},a,r)},this.run.call(this,s),c.always(this.always),c.promise()},AeroGear.DataManager.adapters.WebSQL.prototype.remove=function(e,t){t=t||{};var a,r,s,o,n=this,i=this.getStoreName(),c=(this.getDatabase(),jQuery.Deferred()),u=0;return o=function(o){s=function(e,a){c.reject(a,"error",t.error)},r=function(){n.read().done(function(e,a){"success"===a?c.resolve(e,a,t.success):c.reject(e,a,t.error)})},a="DELETE FROM "+i,e?(e=AeroGear.isArray(e)?e:[e],o.transaction(function(t){for(u;e.length>u;u++)if("string"==typeof e[u]||"number"==typeof e[u])t.executeSql(a+" WHERE ID = ? ",[e[u]]);else{if(!e)continue;t.executeSql(a+" WHERE ID = ? ",[e[u][this.getRecordId()]])}},s,r)):o.transaction(function(e){e.executeSql(a,[],r,s)})},this.run.call(this,o),c.always(this.always),c.promise()},AeroGear.DataManager.adapters.WebSQL.prototype.filter=function(e,a,r){r=r||{};var s,o=this,n=jQuery.Deferred();return this.getDatabase(),s=function(){this.read().then(function(s,i){return"success"!==i?(n.reject(s,i,r.error),t):(AeroGear.DataManager.adapters.Memory.prototype.save.call(o,s,!0),AeroGear.DataManager.adapters.Memory.prototype.filter.call(o,e,a).then(function(e){n.resolve(e,"success",r.success)}),t)})},this.run.call(this,s),n.always(this.always),n.promise()},AeroGear.DataManager.validateAdapter("WebSQL",AeroGear.DataManager.adapters.WebSQL)})(this);
