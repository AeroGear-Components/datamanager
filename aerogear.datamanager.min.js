/*! AeroGear JavaScript Library - v2.1.0 - 2015-03-12
* https://github.com/aerogear/aerogear-js
* JBoss, Home of Professional Open Source
* Copyright Red Hat, Inc., and individual contributors
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
* http://www.apache.org/licenses/LICENSE-2.0
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
!function(a,b){this.AeroGear={},AeroGear.Core=function(){if(this instanceof AeroGear.Core)throw"Invalid instantiation of base class AeroGear.Core";this.add=function(a){var b,c,d=this[this.collectionName]||{};if(this[this.collectionName]=d,!a)return this;if("string"==typeof a)d[a]=AeroGear[this.lib].adapters[this.type](a,this.config);else if(Array.isArray(a))for(b=0;b<a.length;b++)c=a[b],"string"==typeof c?d[c]=AeroGear[this.lib].adapters[this.type](c,this.config):c.name&&(c.settings=AeroGear.extend(c.settings||{},this.config),d[c.name]=AeroGear[this.lib].adapters[c.type||this.type](c.name,c.settings));else{if(!a.name)return this;a.settings=AeroGear.extend(a.settings||{},this.config),d[a.name]=AeroGear[this.lib].adapters[a.type||this.type](a.name,a.settings)}return this[this.collectionName]=d,this},this.remove=function(a){var b,c,d=this[this.collectionName]||{};if("string"==typeof a)delete d[a];else if(Array.isArray(a))for(b=0;b<a.length;b++)c=a[b],"string"==typeof c?delete d[c]:delete d[c.name];else a&&delete d[a.name];return this[this.collectionName]=d,this}},AeroGear.extend=function(){var a,b,c,d=arguments[0];for(b=1;b<arguments.length;b++){c=arguments[b];for(a in c)d[a]=c[a]}return d},AeroGear.DataManager=function(a){return this instanceof AeroGear.DataManager?(this.add=function(a){a=a||{};var b,c,d,e,f;a=Array.isArray(a)?a:[a],a=a.map(function(a){if(f=a.settings||{},d=f.fallback===!1?!1:!0,d&&(e=f.preferred?f.preferred:AeroGear.DataManager.preferred,"string"!=typeof a&&(c=a.type||"Memory",!(c in AeroGear.DataManager.validAdapters))))for(b=0;b<e.length;b++)if(e[b]in AeroGear.DataManager.validAdapters)return("IndexedDB"===c||"WebSQL"===c)&&(a.settings=AeroGear.extend(a.settings||{},{async:!0})),a.type=e[b],a;return a},this),AeroGear.Core.call(this),this.add(a),this.add=this._add},this._add=this.add,this.remove=function(a){AeroGear.Core.call(this),this.remove(a),this.remove=this._remove},this._remove=this.remove,this.lib="DataManager",this.type=a?a.type||"Memory":"Memory",this.collectionName="stores",void this.add(a)):new AeroGear.DataManager(a)},AeroGear.DataManager.prototype=AeroGear.Core,AeroGear.DataManager.constructor=AeroGear.DataManager,AeroGear.DataManager.validAdapters={},AeroGear.DataManager.preferred=["IndexedDB","WebSQL","SessionLocal","Memory"],AeroGear.DataManager.validateAdapter=function(a,b){b.isValid()&&(AeroGear.DataManager.validAdapters[a]=b)},AeroGear.DataManager.adapters={},AeroGear.DataManager.STATUS_NEW=1,AeroGear.DataManager.STATUS_MODIFIED=2,AeroGear.DataManager.STATUS_REMOVED=0,AeroGear.DataManager.adapters.base=function(b,c){if(this instanceof AeroGear.DataManager.adapters.base)throw"Invalid instantiation of base class AeroGear.DataManager.adapters.base";c=c||{};var d=null,e=c.recordId?c.recordId:"id",f=c.crypto||{},g=f.options||{};this.getData=function(){return d||[]},this.setData=function(a){d=a},this.getRecordId=function(){return e},this.encrypt=function(c){var d;return f.agcrypto?(g.data=sjcl.codec.utf8String.toBits(JSON.stringify(c)),d={id:c[e],data:f.agcrypto.encrypt(g)},a.localStorage.setItem("ag-"+b+"-IV",JSON.stringify({id:f.agcrypto.getIV()})),d):c},this.decrypt=function(c,d){var e,h;return f.agcrypto?(h=JSON.parse(a.localStorage.getItem("ag-"+b+"-IV"))||{},g.IV=h.id,c=Array.isArray(c)?c:[c],e=c.map(function(a){return g.data=a.data,JSON.parse(sjcl.codec.utf8String.fromBits(f.agcrypto.decrypt(g)))}),d?e[0]:e):c}},AeroGear.DataManager.adapters.Memory=function(a,b){return this instanceof AeroGear.DataManager.adapters.Memory?(AeroGear.DataManager.adapters.base.apply(this,arguments),this.emptyData=function(){this.setData(null)},this.addDataRecord=function(a){this.getData().push(a)},this.updateDataRecord=function(a,b){this.getData()[a]=b},this.removeDataRecord=function(a){this.getData().splice(a,1)},this.open=function(){return Promise.resolve()},this.close=function(){},void(this.traverseObjects=function(a,b,c){for(;"object"==typeof b&&c;)a=Object.keys(b)[0],b=b[a],c=c[a];return b===c?!0:!1})):new AeroGear.DataManager.adapters.Memory(a,b)},AeroGear.DataManager.adapters.Memory.isValid=function(){return!0},AeroGear.DataManager.adapters.Memory.prototype.read=function(a){var b={};return b[this.getRecordId()]=a,a?this.filter(b).then(function(a){return a}):Promise.resolve(this.getData())},AeroGear.DataManager.adapters.Memory.prototype.save=function(a,b){var c=!1;if(a=Array.isArray(a)?a:[a],b&&b.reset)this.setData(a);else if(this.getData()&&0!==this.getData().length)for(var d=0;d<a.length;d++){for(var e in this.getData())if(this.getData()[e][this.getRecordId()]===a[d][this.getRecordId()]){this.updateDataRecord(e,a[d]),c=!0;break}c||this.addDataRecord(a[d]),c=!1}else this.setData(a);return Promise.resolve(this.getData())},AeroGear.DataManager.adapters.Memory.prototype.remove=function(a){var b,c,d;if(!a)return this.emptyData(),Promise.resolve(this.getData());a=Array.isArray(a)?a:[a];for(var e=0;e<a.length;e++){if("string"==typeof a[e]||"number"==typeof a[e])b=a[e];else{if(!a)continue;b=a[e][this.getRecordId()]}c=this.getData(!0);for(d in c)c[d][this.getRecordId()]===b&&this.removeDataRecord(d)}return Promise.resolve(this.getData())},AeroGear.DataManager.adapters.Memory.prototype.filter=function(a,b){var c,d,e,f,g=this;return a?(c=this.getData().filter(function(c){var h,i,j=b?!1:!0,k=Object.keys(a);for(d=0;d<k.length;d++){if(a[k[d]].data)for(h=a[k[d]],i=h.matchAny?!1:!0,e=0;e<h.data.length;e++)if(Array.isArray(c[k[d]]))if(c[k[d]].length){if(b||h.matchAny){for(f=0;f<c[k[d]].length;f++)if(h.data[e]===c[k[d]][f]){i=!0;break}}else if(c[k[d]].length!==h.data.length)i=!1;else for(f=0;f<c[k[d]].length;f++)if(h.data[f]!==c[k[d]][f]){i=!1;break}}else i=!1;else if("object"==typeof h.data[e]){if(h.matchAny&&g.traverseObjects(k[d],h.data[e],c[k[d]])){i=!0;break}if(!h.matchAny&&!g.traverseObjects(k[d],h.data[e],c[k[d]])){i=!1;break}}else{if(h.matchAny&&h.data[e]===c[k[d]]){i=!0;break}if(!h.matchAny&&h.data[e]!==c[k[d]]){i=!1;break}}else if(Array.isArray(c[k[d]]))if(i=b?!1:!0,c[k[d]].length)for(e=0;e<c[k[d]].length;e++){if(b&&a[k[d]]===c[k[d]][e]){i=!0;break}if(!b&&a[k[d]]!==c[k[d]][e]){i=!1;break}}else i=!1;else i="object"==typeof a[k[d]]?g.traverseObjects(k[d],a[k[d]],c[k[d]]):a[k[d]]===c[k[d]]?!0:!1;if(b&&i){j=!0;break}if(!b&&!i){j=!1;break}}return j}),Promise.resolve(c)):(c=this.getData()||[],Promise.resolve(c))},AeroGear.DataManager.validateAdapter("Memory",AeroGear.DataManager.adapters.Memory),AeroGear.DataManager.adapters.SessionLocal=function(b,c){if(!(this instanceof AeroGear.DataManager.adapters.SessionLocal))return new AeroGear.DataManager.adapters.SessionLocal(b,c);AeroGear.DataManager.adapters.Memory.apply(this,arguments);var d=c.storageType||"sessionStorage",e=b,f=document.location.pathname.replace(/[\/\.]/g,"-"),g=e+f,h=a[d].getItem(g),i=h?this.decrypt(JSON.parse(h),!0):null;i&&AeroGear.DataManager.adapters.Memory.prototype.save.call(this,i,!0),this.getStoreType=function(){return d},this.getStoreKey=function(){return g}},AeroGear.DataManager.adapters.SessionLocal.isValid=function(){try{return!(!a.localStorage||!a.sessionStorage)}catch(b){return!1}},AeroGear.DataManager.adapters.SessionLocal.prototype=Object.create(new AeroGear.DataManager.adapters.Memory,{save:{value:function(b,c){var d=this,e=c&&c.reset?c.reset:!1,f=a[this.getStoreType()].getItem(this.getStoreKey());return AeroGear.DataManager.adapters.Memory.prototype.save.apply(this,[arguments[0],{reset:e}]).then(function(b){try{a[d.getStoreType()].setItem(d.getStoreKey(),JSON.stringify(d.encrypt(b)))}catch(c){return f=f?JSON.parse(f):[],AeroGear.DataManager.adapters.Memory.prototype.save.apply(d,[f,{reset:e}]).then(function(){return Promise.reject()})}return b})},enumerable:!0,configurable:!0,writable:!0},remove:{value:function(){var b=this;return AeroGear.DataManager.adapters.Memory.prototype.remove.apply(this,arguments).then(function(c){a[b.getStoreType()].setItem(b.getStoreKey(),JSON.stringify(b.encrypt(c)))})},enumerable:!0,configurable:!0,writable:!0}}),AeroGear.DataManager.validateAdapter("SessionLocal",AeroGear.DataManager.adapters.SessionLocal),AeroGear.DataManager.adapters.IndexedDB=function(c,d){if(!a.indexedDB)throw"Your browser doesn't support IndexedDB";if(!(this instanceof AeroGear.DataManager.adapters.IndexedDB))return new AeroGear.DataManager.adapters.IndexedDB(c,d);AeroGear.DataManager.adapters.base.apply(this,arguments),d=d||{};var e,f=d.auto===b||d.auto?!0:!1;this.getDatabase=function(){return e},this.setDatabase=function(a){e=a},this.getStoreName=function(){return c},this.getAsync=function(){return!0},this.run=function(a){var b=this;if(e)a.call(this,e);else{if(!f)throw"Database not opened";this.open().then(function(c,d){if("error"===d)throw"Database not opened";a.call(b,e)})}}},AeroGear.DataManager.adapters.IndexedDB.isValid=function(){return!!a.indexedDB},AeroGear.DataManager.adapters.IndexedDB.prototype.open=function(){var b,c,d=this,e=this.getStoreName(),f=this.getRecordId();return new Promise(function(g,h){b=a.indexedDB.open(e),b.onsuccess=function(a){c=a.target.result,d.setDatabase(c),g(c)},b.onerror=function(a){h(a)},b.onupgradeneeded=function(a){c=a.target.result,c.createObjectStore(e,{keyPath:f})}})},AeroGear.DataManager.adapters.IndexedDB.prototype.read=function(a){var b,c,d,e,f=this,g=[],h=this.getStoreName();return new Promise(function(i,j){f.run.call(f,function(k){return k.objectStoreNames.contains(h)?(b=k.transaction(h),c=b.objectStore(h),a?(e=c.get(a),e.onsuccess=function(){g.push(e.result)}):(d=c.openCursor(),d.onsuccess=function(a){var b=a.target.result;b&&(g.push(b.value),b.continue())}),b.oncomplete=function(){i(f.decrypt(g))},void(b.onerror=function(a){j(a)})):i([])})})},AeroGear.DataManager.adapters.IndexedDB.prototype.save=function(a,b){b=b||{};var c,d,e=this,f=this.getStoreName(),g=0;return new Promise(function(h,i){e.run.call(e,function(j){if(c=j.transaction(f,"readwrite"),d=c.objectStore(f),b.reset&&d.clear(),Array.isArray(a))for(g;g<a.length;g++)d.put(this.encrypt(a[g]));else d.put(this.encrypt(a));c.oncomplete=function(){e.read().then(function(a){h(a)}).catch(function(){i(a,status)})},c.onerror=function(a){i(a)}})})},AeroGear.DataManager.adapters.IndexedDB.prototype.remove=function(a){var b,c,d=this,e=this.getDatabase(),f=this.getStoreName(),g=0;return new Promise(function(h,i){d.run.call(d,function(){if(c=e.transaction(f,"readwrite"),b=c.objectStore(f),a)for(a=Array.isArray(a)?a:[a],g;g<a.length;g++)if("string"==typeof a[g]||"number"==typeof a[g])b.delete(a[g]);else{if(!a)continue;b.delete(a[g][this.getRecordId()])}else b.clear();c.oncomplete=function(){d.read().then(function(a){h(a)}).catch(function(a){i(a)})},c.onerror=function(a){i(a)}})})},AeroGear.DataManager.adapters.IndexedDB.prototype.filter=function(a,b){var c=this;return new Promise(function(d,e){c.run.call(c,function(){this.read().then(function(e){AeroGear.DataManager.adapters.Memory.prototype.save.call(c,e,!0),AeroGear.DataManager.adapters.Memory.prototype.filter.call(c,a,b).then(function(a){d(a)})}).catch(function(a){e(a)})})})},AeroGear.DataManager.adapters.IndexedDB.prototype.close=function(){var a=this.getDatabase();a&&a.close()},AeroGear.DataManager.validateAdapter("IndexedDB",AeroGear.DataManager.adapters.IndexedDB),AeroGear.DataManager.adapters.WebSQL=function(c,d){if(!a.openDatabase)throw"Your browser doesn't support WebSQL";if(!(this instanceof AeroGear.DataManager.adapters.WebSQL))return new AeroGear.DataManager.adapters.WebSQL(c,d);AeroGear.DataManager.adapters.base.apply(this,arguments),d=d||{};var e,f=d.auto===b||d.auto?!0:!1;this.getDatabase=function(){return e},this.setDatabase=function(a){e=a},this.getStoreName=function(){return c},this.getAsync=function(){return!0},this.run=function(a){var b=this;if(e)a.call(this,e);else{if(!f)throw"Database not opened";this.open().then(function(){a.call(b,e)}).catch(function(){throw"Database not opened"})}}},AeroGear.DataManager.adapters.WebSQL.isValid=function(){return!!a.openDatabase},AeroGear.DataManager.adapters.WebSQL.prototype.open=function(){var b,c,d,e=this,f="1",g=2097152,h=this.getRecordId(),i=this.getStoreName();return b=a.openDatabase(i,f,"AeroGear WebSQL Store",g),new Promise(function(a,f){d=function(a,b){f(b)},c=function(){e.setDatabase(b),a(b)},b.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS '"+i+"' ( "+h+" REAL UNIQUE, json)",[],c,d)})})},AeroGear.DataManager.adapters.WebSQL.prototype.close=function(){},AeroGear.DataManager.adapters.WebSQL.prototype.read=function(a){var b,c,d,e=this,f=[],g=[],h=this.getStoreName(),i=this.getDatabase(),j=0;return new Promise(function(k,l){e.run.call(e,function(){d=function(a,b){l(b)},c=function(a,b){var c=b.rows.length;for(j;c>j;j++)f.push(JSON.parse(b.rows.item(j).json));k(e.decrypt(f))},b="SELECT * FROM '"+h+"'",a&&(b+=" WHERE ID = ?",g=[a]),i.transaction(function(a){a.executeSql(b,g,c,d)})})})},AeroGear.DataManager.adapters.WebSQL.prototype.save=function(a,b){b=b||{};var c,d,e=this,f=this.getRecordId(),g=this.getStoreName();return new Promise(function(h,i){e.run.call(e,function(j){c=function(a,b){i(b)},d=function(){e.read().then(function(a){h(a)}).catch(function(a){i(a)})},a=Array.isArray(a)?a:[a],j.transaction(function(c){b.reset&&(c.executeSql("DROP TABLE "+g),c.executeSql("CREATE TABLE IF NOT EXISTS '"+g+"' ( "+f+" REAL UNIQUE, json)")),a.forEach(function(a){a=e.encrypt(a),c.executeSql("INSERT OR REPLACE INTO '"+g+"' ( id, json ) VALUES ( ?, ? ) ",[a[f],JSON.stringify(a)])})},c,d)})})},AeroGear.DataManager.adapters.WebSQL.prototype.remove=function(a){var b,c,d,e=this,f=this.getStoreName(),g=0;return new Promise(function(h,i){e.run.call(e,function(j){d=function(a,b){i(b)},c=function(){e.read().then(function(a){h(a)}).catch(function(a){i(a)})},b="DELETE FROM '"+f+"'",a?(a=Array.isArray(a)?a:[a],j.transaction(function(c){for(g;g<a.length;g++)if("string"==typeof a[g]||"number"==typeof a[g])c.executeSql(b+" WHERE ID = ? ",[a[g]]);else{if(!a)continue;c.executeSql(b+" WHERE ID = ? ",[a[g][this.getRecordId()]])}},d,c)):j.transaction(function(a){a.executeSql(b,[],c,d)})})})},AeroGear.DataManager.adapters.WebSQL.prototype.filter=function(a,b){var c=this;return new Promise(function(d,e){c.run.call(c,function(){this.read().then(function(e){AeroGear.DataManager.adapters.Memory.prototype.save.call(c,e,!0),AeroGear.DataManager.adapters.Memory.prototype.filter.call(c,a,b).then(function(a){d(a)})}).catch(function(a){e(a)})})})},AeroGear.DataManager.validateAdapter("WebSQL",AeroGear.DataManager.adapters.WebSQL)}(this);
//# sourceMappingURL=aerogear.custom.min.js.map