/*! AeroGear JavaScript Library - v1.4.0 - 2014-03-24
* https://github.com/aerogear/aerogear-js
* JBoss, Home of Professional Open Source
* Copyright Red Hat, Inc., and individual contributors
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
* http://www.apache.org/licenses/LICENSE-2.0
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
(function(e,a){this.AeroGear={},AeroGear.Core=function(){if(this instanceof AeroGear.Core)throw"Invalid instantiation of base class AeroGear.Core";this.add=function(e){var a,t,r=this[this.collectionName]||{};if(this[this.collectionName]=r,!e)return this;if("string"==typeof e)r[e]=AeroGear[this.lib].adapters[this.type](e,this.config);else if(AeroGear.isArray(e))for(a=0;e.length>a;a++)t=e[a],"string"==typeof t?r[t]=AeroGear[this.lib].adapters[this.type](t,this.config):t.name&&(t.settings=AeroGear.extend(t.settings||{},this.config),r[t.name]=AeroGear[this.lib].adapters[t.type||this.type](t.name,t.settings));else{if(!e.name)return this;e.settings=AeroGear.extend(e.settings||{},this.config),r[e.name]=AeroGear[this.lib].adapters[e.type||this.type](e.name,e.settings)}return this[this.collectionName]=r,this},this.remove=function(e){var a,t,r=this[this.collectionName]||{};if("string"==typeof e)delete r[e];else if(AeroGear.isArray(e))for(a=0;e.length>a;a++)t=e[a],"string"==typeof t?delete r[t]:delete r[t.name];else e&&delete r[e.name];return this[this.collectionName]=r,this}},AeroGear.isArray=function(e){return"[object Array]"==={}.toString.call(e)},AeroGear.extend=function(e,a){var t;for(t in a)e[t]=a[t];return e},AeroGear.DataManager=function(e){return this instanceof AeroGear.DataManager?(this.add=function(e){e=e||{};var a,t,r,s,o;e=AeroGear.isArray(e)?e:[e],e=e.map(function(e){if(o=e.settings||{},r=o.fallback===!1?!1:!0,r&&(s=o.preferred?o.preferred:AeroGear.DataManager.preferred,"string"!=typeof e&&(t=e.type||"Memory",!(t in AeroGear.DataManager.validAdapters))))for(a=0;s.length>a;a++)if(s[a]in AeroGear.DataManager.validAdapters)return("IndexedDB"===t||"WebSQL"===t)&&(e.settings=AeroGear.extend(e.settings||{},{async:!0})),e.type=s[a],e;return e},this),AeroGear.Core.call(this),this.add(e),this.add=this._add},this._add=this.add,this.remove=function(e){AeroGear.Core.call(this),this.remove(e),this.remove=this._remove},this._remove=this.remove,this.lib="DataManager",this.type=e?e.type||"Memory":"Memory",this.collectionName="stores",this.add(e),a):new AeroGear.DataManager(e)},AeroGear.DataManager.prototype=AeroGear.Core,AeroGear.DataManager.constructor=AeroGear.DataManager,AeroGear.DataManager.validAdapters={},AeroGear.DataManager.preferred=["IndexedDB","WebSQL","SessionLocal","Memory"],AeroGear.DataManager.validateAdapter=function(e,a){a.isValid()&&(AeroGear.DataManager.validAdapters[e]=a)},AeroGear.DataManager.adapters={},AeroGear.DataManager.STATUS_NEW=1,AeroGear.DataManager.STATUS_MODIFIED=2,AeroGear.DataManager.STATUS_REMOVED=0,AeroGear.DataManager.adapters.base=function(a,t){if(this instanceof AeroGear.DataManager.adapters.base)throw"Invalid instantiation of base class AeroGear.DataManager.adapters.base";t=t||{};var r=null,s=t.recordId?t.recordId:"id",o=t.crypto||{},n=o.options||{};this.getData=function(){return r||[]},this.setData=function(e){r=e},this.getRecordId=function(){return s},this.always=function(e,a,t){t&&t.call(this,e,a)},this.encrypt=function(t){var r;return o.agcrypto?(n.data=sjcl.codec.utf8String.toBits(JSON.stringify(t)),r={id:t[s],data:o.agcrypto.encrypt(n)},e.localStorage.setItem("ag-"+a+"-IV",JSON.stringify({id:o.agcrypto.getIV()})),r):t},this.decrypt=function(t,r){var s,i;return o.agcrypto?(i=JSON.parse(e.localStorage.getItem("ag-"+a+"-IV"))||{},n.IV=i.id,t=AeroGear.isArray(t)?t:[t],s=t.map(function(e){return n.data=e.data,JSON.parse(sjcl.codec.utf8String.fromBits(o.agcrypto.decrypt(n)))}),r?s[0]:s):t}},AeroGear.DataManager.adapters.Memory=function(e,t){return this instanceof AeroGear.DataManager.adapters.Memory?(AeroGear.DataManager.adapters.base.apply(this,arguments),this.emptyData=function(){this.setData(null)},this.addDataRecord=function(e){this.getData().push(e)},this.updateDataRecord=function(e,a){this.getData()[e]=a},this.removeDataRecord=function(e){this.getData().splice(e,1)},this.always=function(e,a,t){t&&t.call(this,e,a)},this.open=function(e){return jQuery.Deferred().resolve(a,"success",e&&e.success)},this.close=function(){},this.traverseObjects=function(e,a,t){for(;"object"==typeof a&&t;)e=Object.keys(a)[0],a=a[e],t=t[e];return a===t?!0:!1},a):new AeroGear.DataManager.adapters.Memory(e,t)},AeroGear.DataManager.adapters.Memory.isValid=function(){return!0},AeroGear.DataManager.adapters.Memory.prototype.read=function(e,t){var r,s={},o=jQuery.Deferred();return s[this.getRecordId()]=e,e?this.filter(s).then(function(e){r=e}):r=this.getData(),o.always(this.always),o.resolve(r,"success",t?t.success:a)},AeroGear.DataManager.adapters.Memory.prototype.save=function(e,t){var r=!1,s=jQuery.Deferred();if(e=AeroGear.isArray(e)?e:[e],t&&t.reset)this.setData(e);else if(this.getData()&&0!==this.getData().length)for(var o=0;e.length>o;o++){for(var n in this.getData())if(this.getData()[n][this.getRecordId()]===e[o][this.getRecordId()]){this.updateDataRecord(n,e[o]),r=!0;break}r||this.addDataRecord(e[o]),r=!1}else this.setData(e);return s.always(this.always),s.resolve(this.getData(),"success",t?t.success:a)},AeroGear.DataManager.adapters.Memory.prototype.remove=function(e,t){var r,s,o,n=jQuery.Deferred();if(n.always(this.always),!e)return this.emptyData(),n.resolve(this.getData(),"success",t?t.success:a);e=AeroGear.isArray(e)?e:[e];for(var i=0;e.length>i;i++){if("string"==typeof e[i]||"number"==typeof e[i])r=e[i];else{if(!e)continue;r=e[i][this.getRecordId()]}s=this.getData(!0);for(o in s)s[o][this.getRecordId()]===r&&this.removeDataRecord(o)}return n.resolve(this.getData(),"success",t?t.success:a)},AeroGear.DataManager.adapters.Memory.prototype.filter=function(e,t,r){var s,o,n,i,c,u=this,d=jQuery.Deferred();return d.always(this.always),e?(s=this.getData().filter(function(a){var r,s,d=t?!1:!0,h=Object.keys(e);for(o=0;h.length>o;o++){if(e[h[o]].data)for(r=e[h[o]],s=r.matchAny?!1:!0,n=0;r.data.length>n;n++)if(AeroGear.isArray(a[h[o]]))if(a[h[o]].length){if(0===jQuery(a[h]).not(r.data).length&&0===jQuery(r.data).not(a[h]).length){s=!0;break}for(i=0;a[h[o]].length>i;i++){if(r.matchAny&&r.data[n]===a[h[o]][i]){if(s=!0,t)break;for(c=0;a[h[o]].length>c;c++)if(!t&&r.data[n]!==a[h[o]][c]){s=!1;break}}if(!r.matchAny&&r.data[n]!==a[h[o]][i]){s=!1;break}}}else s=!1;else if("object"==typeof r.data[n]){if(r.matchAny&&u.traverseObjects(h[o],r.data[n],a[h[o]])){s=!0;break}if(!r.matchAny&&!u.traverseObjects(h[o],r.data[n],a[h[o]])){s=!1;break}}else{if(r.matchAny&&r.data[n]===a[h[o]]){s=!0;break}if(!r.matchAny&&r.data[n]!==a[h[o]]){s=!1;break}}else if(AeroGear.isArray(a[h[o]]))if(s=t?!1:!0,a[h[o]].length)for(n=0;a[h[o]].length>n;n++){if(t&&e[h[o]]===a[h[o]][n]){s=!0;break}if(!t&&e[h[o]]!==a[h[o]][n]){s=!1;break}}else s=!1;else s="object"==typeof e[h[o]]?u.traverseObjects(h[o],e[h[o]],a[h[o]]):e[h[o]]===a[h[o]]?!0:!1;if(t&&s){d=!0;break}if(!t&&!s){d=!1;break}}return d}),d.resolve(s,"success",r?r.success:a)):(s=this.getData()||[],d.resolve(s,"success",r?r.success:a))},AeroGear.DataManager.validateAdapter("Memory",AeroGear.DataManager.adapters.Memory),AeroGear.DataManager.adapters.SessionLocal=function(a,t){if(!(this instanceof AeroGear.DataManager.adapters.SessionLocal))return new AeroGear.DataManager.adapters.SessionLocal(a,t);AeroGear.DataManager.adapters.Memory.apply(this,arguments);var r=t.storageType||"sessionStorage",s=a,o=document.location.pathname.replace(/[\/\.]/g,"-"),n=s+o,i=e[r].getItem(n),c=i?this.decrypt(JSON.parse(i),!0):null;c&&AeroGear.DataManager.adapters.Memory.prototype.save.call(this,c,!0),this.getStoreType=function(){return r},this.getStoreKey=function(){return n}},AeroGear.DataManager.adapters.SessionLocal.isValid=function(){try{return!(!e.localStorage||!e.sessionStorage)}catch(a){return!1}},AeroGear.DataManager.adapters.SessionLocal.prototype=Object.create(new AeroGear.DataManager.adapters.Memory,{save:{value:function(t,r){var s,o=jQuery.Deferred(),n=r&&r.reset?r.reset:!1,i=e[this.getStoreType()].getItem(this.getStoreKey());AeroGear.DataManager.adapters.Memory.prototype.save.apply(this,[arguments[0],{reset:n}]).then(function(e){s=e}),o.always(this.always);try{e[this.getStoreType()].setItem(this.getStoreKey(),JSON.stringify(this.encrypt(s))),r&&r.success&&r.storageSuccess(s)}catch(c){if(i=i?JSON.parse(i):[],AeroGear.DataManager.adapters.Memory.prototype.save.apply(this,[i,{reset:n}]).then(function(e){s=e}),r&&r.error)return o.reject(t,"error",r?r.error:a);throw o.reject(),c}return o.resolve(s,"success",r?r.success:a)},enumerable:!0,configurable:!0,writable:!0},remove:{value:function(t,r){var s,o=jQuery.Deferred();return AeroGear.DataManager.adapters.Memory.prototype.remove.apply(this,arguments).then(function(e){s=e}),e[this.getStoreType()].setItem(this.getStoreKey(),JSON.stringify(this.encrypt(s))),o.always(this.always),o.resolve(s,status,r?r.success:a)},enumerable:!0,configurable:!0,writable:!0}}),AeroGear.DataManager.validateAdapter("SessionLocal",AeroGear.DataManager.adapters.SessionLocal),AeroGear.DataManager.adapters.IndexedDB=function(a,t){if(!e.indexedDB)throw"Your browser doesn't support IndexedDB";if(!(this instanceof AeroGear.DataManager.adapters.IndexedDB))return new AeroGear.DataManager.adapters.IndexedDB(a,t);AeroGear.DataManager.adapters.base.apply(this,arguments),t=t||{};var r,s=t.auto;this.getDatabase=function(){return r},this.setDatabase=function(e){r=e},this.getStoreName=function(){return a},this.getAsync=function(){return!0},this.run=function(e){var a=this;if(r)e.call(this,r);else{if(!s)throw"Database not opened";this.open().always(function(t,s){if("error"===s)throw"Database not opened";e.call(a,r)})}}},AeroGear.DataManager.adapters.IndexedDB.isValid=function(){return!!e.indexedDB},AeroGear.DataManager.adapters.IndexedDB.prototype.open=function(a){a=a||{};var t,r,s=this,o=this.getStoreName(),n=this.getRecordId(),i=jQuery.Deferred();return t=e.indexedDB.open(o),t.onsuccess=function(e){r=e.target.result,s.setDatabase(r),i.resolve(r,"success",a.success)},t.onerror=function(e){i.reject(e,"error",a.error)},t.onupgradeneeded=function(e){r=e.target.result,r.createObjectStore(o,{keyPath:n})},i.always(this.always),i.promise()},AeroGear.DataManager.adapters.IndexedDB.prototype.read=function(e,a){a=a||{};var t,r,s,o,n,i=this,c=[],u=(this.getDatabase(),this.getStoreName()),d=jQuery.Deferred();return n=function(n){n.objectStoreNames.contains(u)||d.resolve([],"success",a.success),t=n.transaction(u),r=t.objectStore(u),e?(o=r.get(e),o.onsuccess=function(){c.push(o.result)}):(s=r.openCursor(),s.onsuccess=function(e){var a=e.target.result;a&&(c.push(a.value),a.continue())}),t.oncomplete=function(){d.resolve(i.decrypt(c),"success",a.success)},t.onerror=function(e){d.reject(e,"error",a.error)}},this.run.call(this,n),d.always(this.always),d.promise()},AeroGear.DataManager.adapters.IndexedDB.prototype.save=function(e,a){a=a||{};var t,r,s,o=this,n=(this.getDatabase(),this.getStoreName()),i=jQuery.Deferred(),c=0;return s=function(s){if(t=s.transaction(n,"readwrite"),r=t.objectStore(n),a.reset&&r.clear(),AeroGear.isArray(e))for(c;e.length>c;c++)r.put(this.encrypt(e[c]));else r.put(this.encrypt(e));t.oncomplete=function(){o.read().done(function(e,t){"success"===t?i.resolve(e,t,a.success):i.reject(e,t,a.error)})},t.onerror=function(e){i.reject(e,"error",a.error)}},this.run.call(this,s),i.always(this.always),i.promise()},AeroGear.DataManager.adapters.IndexedDB.prototype.remove=function(e,a){a=a||{};var t,r,s,o=this,n=this.getDatabase(),i=this.getStoreName(),c=jQuery.Deferred(),u=0;return s=function(){if(r=n.transaction(i,"readwrite"),t=r.objectStore(i),e)for(e=AeroGear.isArray(e)?e:[e],u;e.length>u;u++)if("string"==typeof e[u]||"number"==typeof e[u])t.delete(e[u]);else{if(!e)continue;t.delete(e[u][this.getRecordId()])}else t.clear();r.oncomplete=function(){o.read().done(function(e,t){"success"===t?c.resolve(e,t,a.success):c.reject(e,t,a.error)})},r.onerror=function(e){c.reject(e,"error",a.error)}},this.run.call(this,s),c.always(this.always),c.promise()},AeroGear.DataManager.adapters.IndexedDB.prototype.filter=function(e,t,r){r=r||{};var s,o=this,n=jQuery.Deferred();return this.getDatabase(),s=function(){this.read().then(function(s,i){return"success"!==i?(n.reject(s,i,r.error),a):(AeroGear.DataManager.adapters.Memory.prototype.save.call(o,s,!0),AeroGear.DataManager.adapters.Memory.prototype.filter.call(o,e,t).then(function(e){n.resolve(e,"success",r.success)}),a)})},this.run.call(this,s),n.always(this.always),n.promise()},AeroGear.DataManager.adapters.IndexedDB.prototype.close=function(){var e=this.getDatabase();e&&e.close()},AeroGear.DataManager.validateAdapter("IndexedDB",AeroGear.DataManager.adapters.IndexedDB),AeroGear.DataManager.adapters.WebSQL=function(a,t){if(!e.openDatabase)throw"Your browser doesn't support WebSQL";if(!(this instanceof AeroGear.DataManager.adapters.WebSQL))return new AeroGear.DataManager.adapters.WebSQL(a,t);AeroGear.DataManager.adapters.base.apply(this,arguments),t=t||{};var r,s=t.auto;this.getDatabase=function(){return r},this.setDatabase=function(e){r=e},this.getStoreName=function(){return a},this.getAsync=function(){return!0},this.run=function(e){var a=this;if(r)e.call(this,r);else{if(!s)throw"Database not opened";this.open().always(function(t,s){if("error"===s)throw"Database not opened";e.call(a,r)})}}},AeroGear.DataManager.adapters.WebSQL.isValid=function(){return!!e.openDatabase},AeroGear.DataManager.adapters.WebSQL.prototype.open=function(a){a=a||{};var t,r,s,o=this,n="1",i=2097152,c=this.getRecordId(),u=this.getStoreName(),d=jQuery.Deferred();return s=e.openDatabase(u,n,"AeroGear WebSQL Store",i),r=function(e,t){d.reject(t,"error",a.error)},t=function(){o.setDatabase(s),d.resolve(s,"success",a.success)},s.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS '"+u+"' ( "+c+" REAL UNIQUE, json)",[],t,r)}),d.always(this.always),d.promise()},AeroGear.DataManager.adapters.WebSQL.prototype.read=function(e,a){a=a||{};var t,r,s,o,n=this,i=[],c=[],u=this.getStoreName(),d=(this.getDatabase(),jQuery.Deferred()),h=0;return o=function(o){r=function(e,t){d.reject(t,"error",a.error)},t=function(e,t){var r=t.rows.length;for(h;r>h;h++)i.push(JSON.parse(t.rows.item(h).json));d.resolve(n.decrypt(i),"success",a.success)},s="SELECT * FROM '"+u+"'",e&&(s+=" WHERE ID = ?",c=[e]),o.transaction(function(e){e.executeSql(s,c,t,r)})},this.run.call(this,o),d.always(this.always),d.promise()},AeroGear.DataManager.adapters.WebSQL.prototype.save=function(e,a){a=a||{};var t,r,s,o=this,n=this.getRecordId(),i=(this.getDatabase(),this.getStoreName()),c=jQuery.Deferred();return s=function(s){t=function(e,t){c.reject(t,"error",a.error)},r=function(){o.read().done(function(e,t){"success"===t?c.resolve(e,t,a.success):c.reject(e,t,a.error)})},e=AeroGear.isArray(e)?e:[e],s.transaction(function(t){a.reset&&(t.executeSql("DROP TABLE "+i),t.executeSql("CREATE TABLE IF NOT EXISTS '"+i+"' ( "+n+" REAL UNIQUE, json)")),e.forEach(function(e){e=o.encrypt(e),t.executeSql("INSERT OR REPLACE INTO '"+i+"' ( id, json ) VALUES ( ?, ? ) ",[e[n],JSON.stringify(e)])})},t,r)},this.run.call(this,s),c.always(this.always),c.promise()},AeroGear.DataManager.adapters.WebSQL.prototype.remove=function(e,a){a=a||{};var t,r,s,o,n=this,i=this.getStoreName(),c=(this.getDatabase(),jQuery.Deferred()),u=0;return o=function(o){s=function(e,t){c.reject(t,"error",a.error)},r=function(){n.read().done(function(e,t){"success"===t?c.resolve(e,t,a.success):c.reject(e,t,a.error)})},t="DELETE FROM '"+i+"'",e?(e=AeroGear.isArray(e)?e:[e],o.transaction(function(a){for(u;e.length>u;u++)if("string"==typeof e[u]||"number"==typeof e[u])a.executeSql(t+" WHERE ID = ? ",[e[u]]);else{if(!e)continue;a.executeSql(t+" WHERE ID = ? ",[e[u][this.getRecordId()]])}},s,r)):o.transaction(function(e){e.executeSql(t,[],r,s)})},this.run.call(this,o),c.always(this.always),c.promise()},AeroGear.DataManager.adapters.WebSQL.prototype.filter=function(e,t,r){r=r||{};var s,o=this,n=jQuery.Deferred();return this.getDatabase(),s=function(){this.read().then(function(s,i){return"success"!==i?(n.reject(s,i,r.error),a):(AeroGear.DataManager.adapters.Memory.prototype.save.call(o,s,!0),AeroGear.DataManager.adapters.Memory.prototype.filter.call(o,e,t).then(function(e){n.resolve(e,"success",r.success)}),a)})},this.run.call(this,s),n.always(this.always),n.promise()},AeroGear.DataManager.validateAdapter("WebSQL",AeroGear.DataManager.adapters.WebSQL)})(this);
//@ sourceMappingURL=aerogear.js.map